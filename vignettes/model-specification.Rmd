---
title: "model-specification"
author: "Oliver Jayasinghe and Rex Parsons"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{model-specification}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(GLMMcosinor)
library(dplyr)
#' @srrstats {G2.0a} Provide explicit secondary documentation of any expectations on lengths of inputs
#' @srrstats {G2.1a} *Provide explicit secondary documentation of expectations on data types of all vector inputs.*
#' @srrstats {RE1.1} *Regression Software should document how formula interfaces are converted to matrix representations of input data.*


testdata_simple <- simulate_cosinor(1000,
  n_period = 2,
  mesor = 5,
  amp = 2,
  acro = 1,
  beta.mesor = 4,
  beta.amp = 1,
  beta.acro = 0.5,
  family = "poisson",
  period = c(12),
  n_components = 1,
  beta.group = TRUE
)

testdata_two_components <- simulate_cosinor(1000,
  n_period = 10,
  mesor = 7,
  amp = c(0.1, 0.4),
  acro = c(1, 1.5),
  beta.mesor = 4.4,
  beta.amp = c(2, 1),
  beta.acro = c(1, -1.5),
  family = "poisson",
  period = c(12, 6),
  n_components = 2,
  beta.group = TRUE
)

testdata_multicomponent <- simulate_cosinor(1000,
  n_period = 10,
  mesor = 7,
  amp = c(0.1, 0.4, 0.5),
  acro = c(1, 1.5, 0.1),
  beta.mesor = 4.4,
  beta.amp = c(2, 1, 0.4),
  beta.acro = c(1, -1.5, -1),
  family = "poisson",
  period = c(12, 6, 12),
  n_components = 3,
  beta.group = TRUE
)
```

## `cosinor.glmm()`

`cosinor.glmm()` wrangles the data appropriately to fit the cosinor
model given the formula specified by the user. It provides estimates of
amplitude, acrophase, and MESOR (Midline Statistic Of Rhythm).

The formula argument for `cosinor.glmm()` is specified using the
`{lme4}` style (for details see `vignette("lmer", package = "lme4")`).
The only difference is that it allows for use of an `amp_acro()` call
within the formula that is used to identify the circadian components and
relevant variables in the `data.frame`. Any other combination of
covariates can also be included in the formula as well as random effects
and zero-inflation (`ziformula`) and dispersion (`dispformula`)
formulae. For detailed examples of how to specify models, see the
[mixed-models](https://rwparsons.github.io/GLMMcosinor/articles/mixed-models.html),
[model-specification](https://rwparsons.github.io/GLMMcosinor/articles/model-specification.html)
and
[multiple-components](https://rwparsons.github.io/GLMMcosinor/articles/multiple-components.html)
vignettes.

## Using cosinor.glmm()

The following examples use data simulated by the the `simulate_cosinor`
function. Since the purpose of GLMMCosinor package is to fit models to
non-Gaussian cosinor distributions, the data will be simulated from a
Poisson distribution in these demonstrations. But, GLMMCosinor can fit
models to data from *any* distribution supported by the `glmmTMB`
package, including Gaussian data.

### Specifying a single-component model with no grouping variable

Here, we fit a simple cosinor model to "testdata_simple" - simulated
data from a Poisson distribution loaded in this vignette. In this
example, there is no grouping variable.

```{r, message=F, warning=F}
cosinor.glmm(Y ~ amp_acro(times, period = 12), data = filter(testdata_simple, group == 0), family = poisson())
```

The output shows the estimates for the raw coefficients in addition to
the transformed estimates for amplitude (amp) and acrophase (acr) and
MESOR (`(Intercept)`). The previous section of this vignette: **'An
overview of the statistical methods used for parameter estimation'**
outlines the difference between the raw coefficients and the transformed
coefficients.

Focussing on the output, the `(Intercept)` is the MESOR (Midline
Statistic Of Rhythm) or rhythm-adjusted mean, `amp` is the amplitude
estimate, and `acr` is the acrophase estimate.

### Specifying a single-component model with a grouping variable

Now, we can add a grouping variable by adding the name of the group in
the `amp_acro()` function:

```{r, message=F, warning=F}
cosinor.glmm(Y ~ amp_acro(times, period = 12, group = "group"), data = testdata_simple, family = poisson())
```

In the example above, the amplitude and phase are being estimated
separately for the two groups but the **intercept term is shared**. This
represents a shared estimate of the MESOR for both groups.

### Specifying a single-component model with a grouping variable and an intercept (MESOR)

Similarly to a normal regression model with `{lme4}` or `{glmmTMB}`, we
can add a term for the group in the model so that we can estimate the
**difference in MESOR** between the two groups.

```{r, message=F, warning=F}
cosinor.glmm(Y ~ group + amp_acro(times, period = 12, group = "group"), data = testdata_simple, family = poisson())
```

We may also be interested in estmating the MESOR for the two groups
separately, rather than the difference between groups. To achieve this,
we can remove the intercept term by using `0 +`.

```{r, message=F, warning=F}
cosinor.glmm(Y ~ 0 + group + amp_acro(times, period = 12, group = "group"), data = testdata_simple, family = poisson())
```

### Specifying more complicated models using the `amp_acro()` function

The `amp_acro()` function controls the cosinor components of the (fixed
effects portion of the) model. It provides the user with the ability to
specify grouping structures, the period of the rhythm, and the number of
components. It includes several arguments that the user needs to
specify:

-   `group` (the name of the grouping variable in the dataset). This
    should be a column within the dataset being passed to
    `cosinor.glmm()` as the `data` argument.

-   `time_col` (the name of the time column). Again, ensure that the
    name matches the name of the time values in the dataset. Also,
    ensure that this argument is NOT a string.

-   `n_components` (the number of components). If the user wishes to fit
    a multicomponent cosinor model, they can specify the number of
    components here. The value of n_components will need to match the
    length of the `group` and `period` arguments as these will be
    combined for each component. If a multicomponent model where one
    component is grouped and other aren't, the vector input for group
    must still be the same length as `n_components` but have the
    non-grouped components represented as `group = NA`.

```{r, message=F, warning=F}
cosinor.glmm(Y ~ group + amp_acro(time_col = times, n_components = 2, period = c(12, 6), group = c("group", NA)), data = testdata_two_components, family = poisson())
```

In the example above, we have a multicomponent cosinor model with two
components. The first component is grouped by the `group` variable in
the input data whereas the second component is not grouped. In the
resulting output, we can see that each component is represented by the
suffixes 1 and 2. The first component has the grouping structure but the
second is represented only by the `amp2` and `acr2` transformed
parameter estimates.

If a multicomponent model is specified (`n_components > 1`) but the
length of `group` or `period` is 1, then it will be assumed that the one
`group`/`period` values specified apply to all components:

For instance, the following two `cosinor.glmm()` calls fit the same
models:

```{r, message=F, warning=F}

cosinor.glmm(Y ~ group + amp_acro(times, n_components = 2, period = 12, group = "group"), data = testdata_two_components, family = poisson())


cosinor.glmm(Y ~ group + amp_acro(times, n_components = 2, period = c(12, 12), group = c("group", "group")), data = testdata_two_components, family = poisson())
```

For a detailed explanation of how to specify multi-component models, see
[multiple-components](https://rwparsons.github.io/GLMMcosinor/articles/multiple-components.html)

\### Dispersion and zero-inflation model specification

The `cosinor.glmm()` function optionally allows users to specify
formulas for dispersion and zero-inflation models. These formulas are
independent of the main formula specification:

```{r, message=F, warning=F}
testdata_disp_zi <- simulate_cosinor(1000,
  n_period = 6,
  mesor = 7,
  amp = c(0.1, 0.4, 0.5),
  acro = c(1, 1.5, 0.1),
  beta.mesor = 4.4,
  beta.amp = c(2, 1, 0.4),
  beta.acro = c(1, -1.5, -1),
  family = "gaussian",
  period = c(12, 6, 8),
  n_components = 3
)
object_disp_zi <- cosinor.glmm(
  Y ~ group + amp_acro(times,
    n_components = 3,
    period = c(12, 6, 8),
    group = "group"
  ),
  data = testdata_disp_zi, family = gaussian(),
  dispformula = ~ group + amp_acro(times, n_components = 2, group = "group", period = c(12, 6)),
  ziformula = ~ group + amp_acro(times, n_components = 3, group = "group", period = c(7, 8, 2))
)

object_disp_zi
```

This example shows how dispformula and ziformula can be specified with a
different number of components, with different periods, and with
different group-component assignments. By default, `dispformula = ~1`,
and `ziformula = ~0`.

*Note that in the example above, the value for the periods and the
number of components in the dispersion and zero-inflation formulas were
chosen arbitrarily and purely for demonstration.*

## Using: 'summary.cosinor.glmm.R'

The `summary()` method for `cosinor.glmm` objects provides a more
detailed summary of the model and its parameter estimates and
uncertainty. It outputs the estimates, standard errors, confidence
intervals, and p-values for both the raw model parameters and the
transformed (amplitude, and acrophase) parameters. The summary
statistics do not represent a comparison between any groups for the
cosinor components - that is the role of the `test_cosinor()` function.

Here is an example of how to use `summary()`:

```{r, message=F, warning=F}
object <- cosinor.glmm(Y ~ group + amp_acro(times, period = 12, group = "group"), data = testdata_simple, family = poisson())
summary(object)
```

The summary statistics for dispersion and zero-inflation models will
also be provided by the summary.cosinor.glmm() function, if the original
cosinor.glmm object being analysed contains them. The following
demonstration uses the model specified in the
`Dispersion and zero-inflation model specification` section of this
vignette:

```{r, message=F, warning=F}
summary(object_disp_zi)
```

*Note that this dataset was not simulated with consideration of
dispersion or zero-inflation characteristics, hence the lack of
significant P-values in the model summary for the dispersion and
zero-inflation models.*
